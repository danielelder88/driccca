<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>DRICCA COSMÉTICOS</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdn.tailwindcss.com"></script></head>
<body>
<header class="bg-pink-600 text-white py-4 text-center text-2xl font-bold flex justify-center items-center gap-2 shadow-md"><i class="fa-solid fa-store"></i> DRICCA COSMÉTICOS</header>
<div class="p-4 max-w-3xl mx-auto">
<div id="loginCliente">
<h2 class="text-xl font-bold mt-4 text-pink-600">Login</h2>
<input class="p-2 border rounded w-full mb-2" id="clienteEmail" placeholder="Email" type="email"/>
<input class="p-2 border rounded w-full mb-2" id="clienteSenha" placeholder="Senha" type="password"/>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="loginCliente()">Entrar</button>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="mostrarCadastroCliente()">Cadastrar</button>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="recuperarSenha()">Esqueci a senha</button></div>
<div class="hidden" id="cadastroCliente">
<h2 class="text-xl font-bold mt-4 text-pink-600">Cadastro de Cliente</h2>
<input class="p-2 border rounded w-full mb-2" id="nomeCliente" placeholder="Nome" type="text"/>
<input class="p-2 border rounded w-full mb-2" id="emailCliente" placeholder="Email" type="email"/>
<input class="p-2 border rounded w-full mb-2" id="senhaCliente" placeholder="Senha" type="password"/>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="cadastrarCliente()">Cadastrar</button>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="mostrarLoginCliente()">Voltar</button>
</div>
<div class="hidden" id="areaCliente">
<h2 class="text-xl font-bold mt-4 text-pink-600">Bem-vindo, <span id="nomeExibicao"></span></h2>
<div id="produtosContainer"></div>
<h3 class="text-lg font-semibold mt-6 text-pink-600">Carrinho</h3>
<div id="carrinhoContainer"></div>
<div id="totalCarrinho" style="margin:10px 0; font-weight:bold;"></div>
<input class="p-2 border rounded w-full mb-2" id="cupomInput" placeholder="Cupom de desconto" type="text"/>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="finalizarPedido()">Finalizar Pedido (WhatsApp)</button>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="logoutCliente()" style="margin-top:10px;">Sair</button>
<h3 class="text-lg font-semibold mt-6 text-pink-600">Fale com o suporte</h3>
<textarea class="p-2 border rounded w-full mb-2" id="mensagemSuporte" placeholder="Escreva sua dúvida..." rows="4"></textarea>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="enviarMensagemSuporte()">Enviar Mensagem</button>
</div>
<div class="hidden" id="areaAdmin">
<h2 class="text-xl font-bold mt-4 text-pink-600">Painel Administrativo</h2>
<div id="painelVendas"></div>
<h3 class="text-lg font-semibold mt-6 text-pink-600">Pedidos</h3>
<div id="pedidosContainer"></div>
<h3 class="text-lg font-semibold mt-6 text-pink-600">Cadastrar Produto</h3>
<input class="p-2 border rounded w-full mb-2" id="produtoNome" placeholder="Nome do produto" type="text"/>
<input class="p-2 border rounded w-full mb-2" id="produtoDescricao" placeholder="Descrição" type="text"/>
<input class="p-2 border rounded w-full mb-2" id="produtoPreco" placeholder="Preço" type="number"/>
<input class="p-2 border rounded w-full mb-2" id="produtoQtd" placeholder="Quantidade" type="number"/>
<input class="p-2 border rounded w-full mb-2" id="produtoImagem" placeholder="URL da imagem" type="text"/>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="cadastrarProduto()">Cadastrar Produto</button>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded mt-2" onclick="logoutCliente()" style="margin-top:10px;">Sair</button>
<h3 class="text-lg font-semibold mt-6 text-pink-600">Gráfico de Vendas</h3>
<canvas height="200" id="graficoVendas" width="400"></canvas>
<h3 class="text-lg font-semibold mt-6 text-pink-600">Mensagens de Suporte</h3>
<div id="mensagensSuporte"></div>

<h3 class="text-lg font-semibold mt-6 text-pink-600">Relatório</h3>
<button onclick="exportarRelatorioPedidos()">Exportar Relatório (PDF)</button>
</div>
</div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAu0i-nJRJFhUmcB2NCYcueR0i7xGA4Rws",
    authDomain: "dricca-ecommerce.firebaseapp.com",
    projectId: "dricca-ecommerce",
    storageBucket: "dricca-ecommerce.appspot.com",
    messagingSenderId: "202913391561",
    appId: "1:202913391561:web:50cddc607a67540be4be18"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let usuarioAtual = null;
  let carrinho = [];

  function mostrarCadastroCliente() {
    document.getElementById('loginCliente').classList.add('hidden');
    document.getElementById('cadastroCliente').classList.remove('hidden');
  }

  function mostrarLoginCliente() {
    document.getElementById('cadastroCliente').classList.add('hidden');
    document.getElementById('areaCliente').classList.add('hidden');
    document.getElementById('areaAdmin').classList.add('hidden');
    document.getElementById('loginCliente').classList.remove('hidden');
  }

  function mostrarAreaCliente(nome) {
    document.getElementById('loginCliente').classList.add('hidden');
    document.getElementById('cadastroCliente').classList.add('hidden');
    document.getElementById('areaCliente').classList.remove('hidden');
    document.getElementById('nomeExibicao').innerText = nome;
    listarProdutos();
  }

  function mostrarAreaAdmin() {
    document.getElementById('loginCliente').classList.add('hidden');
    document.getElementById('areaAdmin').classList.remove('hidden');
    carregarPedidos();
  }

  function cadastrarCliente() {
    const nome = document.getElementById('nomeCliente').value;
    const email = document.getElementById('emailCliente').value;
    const senha = document.getElementById('senhaCliente').value;
    auth.createUserWithEmailAndPassword(email, senha)
      .then(cred => db.collection("clientes").doc(cred.user.uid).set({ nome, email }))
      .then(() => {
        alert("Cadastro realizado!");
        mostrarLoginCliente();
      })
      .catch(e => alert("Erro: " + e.message));
  }

  function loginCliente() {
    const email = document.getElementById('clienteEmail').value;
    const senha = document.getElementById('clienteSenha').value;
    auth.signInWithEmailAndPassword(email, senha)
      .then(cred => {
        if (email === "admin@admin.com") {
          mostrarAreaAdmin();
        } else {
          return db.collection("clientes").doc(cred.user.uid).get().then(doc => {
            if (doc.exists) {
              usuarioAtual = doc.data();
              mostrarAreaCliente(usuarioAtual.nome);
            }
          });
        }
      })
      .catch(e => alert("Erro: " + e.message));
  }

  function logoutCliente() {
    if (confirm("Deseja sair da sua conta?")) {
      auth.signOut().then(() => {
        usuarioAtual = null;
        carrinho = [];
        mostrarLoginCliente();
      });
    }
  }

  function listarProdutos() {
    const container = document.getElementById("produtosContainer");
    container.innerHTML = "";
    db.collection("produtos").get().then(snapshot => {
      snapshot.forEach(doc => {
        const p = doc.data();
        const id = doc.id;
        container.innerHTML += `
          <div class="produto">
            <img src="${p.imagem}" width="100"><br>
            <strong>${p.nome}</strong><br>${p.descricao}<br>
            <strong>R$ ${p.preco.toFixed(2)}</strong><br>Estoque: ${p.quantidade}<br><br>
            <button onclick="adicionarAoCarrinho('${id}', ${p.preco}, '${p.nome}')">Adicionar</button>
          </div>`;
      });
    });
  }

  function adicionarAoCarrinho(id, preco, nome) {
    const existente = carrinho.find(i => i.id === id);
    if (existente) existente.qtd++;
    else carrinho.push({ id, nome, preco, qtd: 1 });
    renderizarCarrinho();
  }

  function alterarQtd(id, delta) {
    const item = carrinho.find(i => i.id === id);
    if (item) {
      item.qtd += delta;
      if (item.qtd <= 0) removerDoCarrinho(id);
      else renderizarCarrinho();
    }
  }

  function removerDoCarrinho(id) {
    carrinho = carrinho.filter(i => i.id !== id);
    renderizarCarrinho();
  }

  function renderizarCarrinho() {
    const container = document.getElementById("carrinhoContainer");
    container.innerHTML = "";
    let total = 0;
    carrinho.forEach(item => {
      total += item.qtd * item.preco;
      container.innerHTML += `<div class='carrinho-item'>
        ${item.nome} (Qtd: ${item.qtd}) - R$ ${(item.qtd * item.preco).toFixed(2)}<br>
        <button onclick="alterarQtd('${item.id}', -1)">–</button>
        <button onclick="alterarQtd('${item.id}', 1)">+</button>
        <button onclick="removerDoCarrinho('${item.id}')">Remover</button>
      </div>`;
    });
    document.getElementById("totalCarrinho").innerText = "Total: R$ " + total.toFixed(2);
  }

  function finalizarPedido() {
    const cupom = document.getElementById("cupomInput").value.trim();
    let total = carrinho.reduce((s, i) => s + i.preco * i.qtd, 0);
    let msg = `Olá, sou ${usuarioAtual.nome}. Gostaria de fazer um pedido:%0A`;
    carrinho.forEach(i => msg += `- ${i.nome} (Qtd: ${i.qtd})%0A`);
    if (cupom === "DESCONTO10") {
      total *= 0.9;
      msg += `Cupom aplicado: DESCONTO10 (10%% OFF)%0A`;
    }
    msg += `Total: R$ ${total.toFixed(2)}`;
    carrinho.forEach(item => {
      const ref = db.collection("produtos").doc(item.id);
      ref.get().then(doc => {
        if (doc.exists) {
          const atual = doc.data().quantidade;
          ref.update({ quantidade: atual - item.qtd });
        }
      });
    });
    db.collection("pedidos").add({ nome: usuarioAtual.nome, total: total.toFixed(2), data: new Date().toISOString(), itens: carrinho });
    window.open(`https://wa.me/5593988098093?text=${msg}`, '_blank');
    carrinho = [];
    renderizarCarrinho();
  }

  function cadastrarProduto() {
    const nome = document.getElementById("produtoNome").value.trim();
    db.collection("produtos").where("nome", "==", nome).get().then(snapshot => {
      if (!snapshot.empty) {
        alert("Produto já cadastrado com esse nome.");
        return;
      }
      const novo = {
        nome,
        descricao: document.getElementById("produtoDescricao").value,
        preco: parseFloat(document.getElementById("produtoPreco").value),
        quantidade: parseInt(document.getElementById("produtoQtd").value),
        imagem: document.getElementById("produtoImagem").value
      };
      db.collection("produtos").add(novo).then(() => alert("Produto cadastrado!"));
    });
  }

  function carregarPedidos() {
    db.collection("pedidos").get().then(snapshot => {
      let total = 0;
      let container = document.getElementById("pedidosContainer");
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const p = doc.data();
        total += parseFloat(p.total);
        container.innerHTML += `<div class='pedido-item'>${p.nome} - R$ ${p.total}<br>${p.data}</div>`;
      });
      document.getElementById("painelVendas").innerHTML = `<strong>Total de Vendas:</strong> R$ ${total.toFixed(2)}`;
    });
  }

  auth.onAuthStateChanged(user => {
    if (user && user.email !== "admin@admin.com") {
      db.collection("clientes").doc(user.uid).get().then(doc => {
        if (doc.exists) {
          usuarioAtual = doc.data();
          mostrarAreaCliente(usuarioAtual.nome);
        }
      });
    } else if (user && user.email === "admin@admin.com") {
      mostrarAreaAdmin();
    }
  });
</script>
<script>
const { jsPDF } = window.jspdf;

function recuperarSenha() {
  const email = document.getElementById('clienteEmail').value;
  if (!email) return alert("Digite seu email para recuperar a senha.");
  auth.sendPasswordResetEmail(email).then(() => alert("Email de recuperação enviado!"))
  .catch(e => alert("Erro: " + e.message));
}

function enviarMensagemSuporte() {
  const texto = document.getElementById("mensagemSuporte").value.trim();
  if (!texto) return alert("Digite a mensagem antes de enviar.");
  db.collection("suporte").add({
    nome: usuarioAtual.nome,
    mensagem: texto,
    data: new Date().toISOString()
  }).then(() => {
    alert("Mensagem enviada!");
    document.getElementById("mensagemSuporte").value = "";
  });
}

// Alterar carregarPedidos para adicionar gráfico e suporte
carregarPedidos = function () {
  db.collection("pedidos").get().then(snapshot => {
    let total = 0;
    let container = document.getElementById("pedidosContainer");
    let vendasPorMes = {};
    container.innerHTML = "";
    snapshot.forEach(doc => {
      const p = doc.data();
      total += parseFloat(p.total);
      const data = new Date(p.data);
      const mes = data.toLocaleString('default', { month: 'short' }) + '/' + data.getFullYear();
      vendasPorMes[mes] = (vendasPorMes[mes] || 0) + parseFloat(p.total);
      container.innerHTML += `<div class='pedido-item'>${p.nome} - R$ ${p.total}<br>${p.data}</div>`;
    });
    document.getElementById("painelVendas").innerHTML = `<strong>Total de Vendas:</strong> R$ ${total.toFixed(2)}`;
    const labels = Object.keys(vendasPorMes);
    const dados = Object.values(vendasPorMes);
    new Chart(document.getElementById("graficoVendas"), {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Vendas por mês',
          data: dados,
          backgroundColor: '#d63384'
        }]
      }
    });
  });

  db.collection("suporte").orderBy("data", "desc").get().then(snapshot => {
    let suporteContainer = document.getElementById("mensagensSuporte");
    suporteContainer.innerHTML = "";
    snapshot.forEach(doc => {
      const s = doc.data();
      suporteContainer.innerHTML += `<div class='pedido-item'><strong>${s.nome}</strong>: ${s.mensagem}<br>${s.data}</div>`;
    });
  });
};

// Atualizar finalizarPedido para gerar PDF
const oldFinalizar = finalizarPedido;
finalizarPedido = function () {
  const cupom = document.getElementById("cupomInput").value.trim();
  let total = carrinho.reduce((s, i) => s + i.preco * i.qtd, 0);
  let msg = `Olá, sou ${usuarioAtual.nome}. Gostaria de fazer um pedido:%0A`;
  const docPDF = new jsPDF();
  docPDF.setFontSize(16);
  docPDF.text("Pedido - Dricca Cosméticos", 10, 10);
  docPDF.setFontSize(12);
  let linha = 20;
  docPDF.text(`Cliente: ${usuarioAtual.nome}`, 10, linha);
  linha += 10;
  carrinho.forEach(i => {
    msg += `- ${i.nome} (Qtd: ${i.qtd})%0A`;
    docPDF.text(`- ${i.nome} (Qtd: ${i.qtd}) - R$ ${(i.qtd * i.preco).toFixed(2)}`, 10, linha);
    linha += 10;
  });
  if (cupom === "DESCONTO10") {
    total *= 0.9;
    msg += `Cupom aplicado: DESCONTO10 (10%% OFF)%0A`;
    docPDF.text("Cupom aplicado: DESCONTO10 (10% OFF)", 10, linha);
    linha += 10;
  }
  msg += `Total: R$ ${total.toFixed(2)}`;
  docPDF.text(`Total: R$ ${total.toFixed(2)}`, 10, linha);
  docPDF.save(`pedido_${usuarioAtual.nome}.pdf`);

  carrinho.forEach(item => {
    const ref = db.collection("produtos").doc(item.id);
    ref.get().then(doc => {
      if (doc.exists) {
        const atual = doc.data().quantidade;
        ref.update({ quantidade: atual - item.qtd });
      }
    });
  });
  db.collection("pedidos").add({ nome: usuarioAtual.nome, total: total.toFixed(2), data: new Date().toISOString(), itens: carrinho });
  window.open(`https://wa.me/5593988098093?text=${msg}`, '_blank');
  carrinho = [];
  renderizarCarrinho();
};
</script><script>
function exportarRelatorioPedidos() {
  db.collection("pedidos").orderBy("data", "desc").get().then(snapshot => {
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("Relatório de Pedidos - Dricca Cosméticos", 10, 10);
    let y = 20;
    snapshot.forEach((docSnap, i) => {
      const p = docSnap.data();
      doc.setFontSize(12);
      doc.text(`${i + 1}. ${p.nome} - R$ ${p.total} - ${p.data}`, 10, y);
      y += 10;
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
    });
    doc.save("relatorio_pedidos.pdf");
  });
}
</script></body>
</html>
